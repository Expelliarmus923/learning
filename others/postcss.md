国庆闲来无事，学习了些postcss相关知识。

postcss不同于less和sass这样的预处理器，他做作用是将CSS解析成抽象语法树（AST）,仅此而已。通过一系列相关插件，你可以重新编译你的CSS成为一个新的字符串，也就是说一切postcss对css进行的操作都是这些插件完成的。目前postcss的插件非常丰富，通过合理使用与搭配，开发者能满足基本的日常需求。

插件列表https://github.com/postcss/postcss/blob/master/docs/plugins.md。

当然也是只能满足日常需求，不过postcss最大的好处就是开发者可以书写自己的插件来满足自己的一些特别的需求。接下来本文会着重介绍关于css的抽象语法数，以及如何书写一个postcss插件。本文默认阅读者拥有postcss的基础知识。

在插件列表中我注意到了2个插件目前非常适合公司现在的工作环境，分别是postcss-webp和postcss-sprites，postcss-webp能够从CSS中找出background属性中的value值中包含了图片信息的声明，生成一条选择器前包含 '.webp'的选择器，并且图片会被替换成webp格式的后缀。postcss-sprites更加神奇，通过雪碧图的合并计算最后生成一张雪碧图，替换掉之前的背景图片，并在用户无感知的情况下更改css。

不得不说两个方法都非常的棒，如果能用在公司的项目中，开发者将无需过多的关系图片使用与性能优化问题，直接把图片上传到cdn即可，在打包的时候打包工具能自动进行这些优化。

正当我准备使用的时候，通过demo发现了这些工具的几个缺点，对于postcss-webp来说，由于公司的图片cdn对于不同类型的图片使用webp的后缀太多，比如b3的图片需要使用!160x160.webp，h0的图片则需要!format750.webp或者!750.webp，有兴趣的同学可以参考公司的关于webp使用的文档。而postcss-webp只提供了replace_from和replace_to这两个配置字段，无法满足需求。postcss-sprites则是只操作本地图片文件，而我们的图片都在cdn上面，需要一个图片下载，拼接雪碧图，再上传，修改css代码的操作。这直接导致了这两个好的工具无法使用。

但是这难不倒我们，我们可以参考他们的思路自己实现，这也是我学习书写postcss插件的原因，接下来我们简单实现一下给所有背景图片额外生成一条webp图片css的插件。

首先我们要先明确几个概念，不知道为什么这几个概念在postcss的中文世界甚至书中都提到的甚少，作为一个刚自学完成的人，我觉得有必要先说下这几个概念。

1. postcss工作原理
这个内容提到的资料挺多的，postcss根据css的内容生成一颗抽象语法数，然后提供了一系列API方法，让使用者非常方便的去操作这颗抽象语法树，在所有插件都处理完成这棵树后再将这颗抽象语法树转换成最终的css。这就是postcss的工作原理。

2.插件的工作顺序
因为postcss的很多插件都遵循单一职责，所以很多时候插件的顺序会被使用者忽略，但是这点很重要，有些情况，我们需要某个插件等另外个插件执行完成之后再执行，所以这里一定要注意顺序。比如如果你使用了postcss-less的话一定要注意这个插件要放在第一是个使用，否则后续插件在使用的时候遇到less的语法会无法解析。

3.一些概念的解析
这个是所有资料中几乎都没提到的，如果你第一次接触postcss插件你可能会一头雾水。
Root：CSS抽象语法树对象中的顶级对象。
Rule: Root.Nodes这个数组中的成员被称为Rule，在CSS中被称为一条规则，比如.class-name {...}就是一条规则。
Declaration：Rule.Nodes这个数组中的成员被称为Declaration，在CSS中被称为一条申明，比如position: absolute;就是一条申明
atRule：是指css中的@语法，比如@import，@font-face。https://developer.mozilla.org/en-US/docs/Web/CSS/@keyframes
Comment： 是指css中的/*...*/格式的注释。
Container： 出现在postcss的api中，postcss把Rule，AtRule，Root看做是容器，而Container可以看做是这些容器的基类，为其提供一些类似数组的方法，方便使用者操作子元素。
Node: 节点，只是一个属性，该属性表示一个容器中的子元素。




了解了上述概念，我们就可以开始实际编写一个postcss插件了，还是拿之前的post-webp来距离，我们需要自己实现一个这样的操作。首先我们搭建一个方便开发调试的环境。

然后书写代码，下面代码能够把css的源代码通过postcss进行编译，其中所有的插件都写在postcss中的参数里。



此时我们在另一个文件夹中编写插件，编写插件的格式如下



我们把测试的CSS代码输入

得到如下的结果


此时在网页加载的时候，我们使用同步的方法判断浏览器是否支持webp，如果支持则给html添加.yeb-webp这样一个class，我们就能够自动的根据样式优先级只加载webp格式图片了。

最后我们如果需要把它作为一个大家都能用的插件的话，可以通过一个叫postcss-plugin的工具编写一个正规的postcss插件了。

最后如果大家想深入学习postcss的话，首先推荐的是直接去github官网，然后向大家推荐一本书《深入postcss Web设计》，这本书看其中几章就好了，其他章节感觉废话居多。虽然如此但是还是对我学习postcss提供了为数不多的中文资料上的帮助。
